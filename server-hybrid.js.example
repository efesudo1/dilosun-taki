const express = require('express');
const path = require('path');
const os = require('os');
const bodyParser = require('body-parser');
const session = require('express-session');
const bcrypt = require('bcrypt');

const app = express();
const PORT = process.env.PORT || 3000;
const HOST = process.env.HOST || '0.0.0.0';

// Middleware
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());
app.use(express.static('public'));

// Session yÃ¶netimi
app.use(session({
    secret: process.env.SESSION_SECRET || 'taki-websitesi-secret-key-2024',
    resave: false,
    saveUninitialized: false,
    cookie: {
        secure: process.env.NODE_ENV === 'production',
        httpOnly: true,
        sameSite: 'lax',
        maxAge: 24 * 60 * 60 * 1000
    }
}));

// EJS template engine
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));

// ========== DATABASE SETUP ==========
let db;

// PostgreSQL kullan eÄŸer DATABASE_URL varsa, yoksa SQLite
if (process.env.DATABASE_URL) {
    // PostgreSQL
    const { Pool } = require('pg');
    db = new Pool({
        connectionString: process.env.DATABASE_URL,
        ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
    });
    console.log('PostgreSQL veritabanÄ±na baÄŸlanÄ±ldÄ±.');
} else {
    // SQLite (local development)
    const sqlite3 = require('sqlite3').verbose();
    const dbPath = path.join(__dirname, 'taki.db');
    db = new sqlite3.Database(dbPath, (err) => {
        if (err) {
            console.error('SQLite baÄŸlantÄ± hatasÄ±:', err.message);
        } else {
            console.log('SQLite veritabanÄ±na baÄŸlandÄ±.');
            db.run('PRAGMA foreign_keys = ON');
        }
    });
}

// TODO: Buraya routing kodlarÄ±nÄ±zÄ± ekleyin
// Bu sadece bir baÅŸlangÄ±Ã§ ÅŸablonu

app.get('/', (req, res) => {
    res.send(`
        <h1>DiloÅŸun TakÄ± DÃ¼nyasÄ±</h1>
        <p>Database: ${process.env.DATABASE_URL ? 'PostgreSQL' : 'SQLite'}</p>
        <p>Environment: ${process.env.NODE_ENV || 'development'}</p>
    `);
});

// Sunucuyu baÅŸlat
app.listen(PORT, HOST, () => {
    console.log('='.repeat(50));
    console.log('ğŸš€ Sunucu baÅŸarÄ±yla baÅŸlatÄ±ldÄ±!');
    console.log('='.repeat(50));
    console.log(`ğŸ“ Port: ${PORT}`);
    console.log(`ğŸ—„ï¸  Database: ${process.env.DATABASE_URL ? 'PostgreSQL' : 'SQLite'}`);
    console.log('='.repeat(50));
});
